# Автобусы на карте Москвы

Веб-приложение показывает передвижение автобусов на карте Москвы.

<img src="screenshots/buses.gif">


## Установка

[Установите Python](https://www.python.org/), если этого ещё не сделали.

Проверьте, что `python` установлен и корректно настроен.
Запустите его в командной строке:
```sh
python --version
```

Скачайте код командой
```shell
git clone https://github.com/mulchus/buses-on-the-map.git
```

В каталоге проекта создайте виртуальное окружение:
```sh
python -m venv venv
```

Активируйте его. На разных операционных системах это делается разными командами:
- Windows: `.\venv\Scripts\activate`
- MacOS/Linux: `source venv/bin/activate`

Установите зависимости командой
```shell
pip install -r requirements.txt
```


## Как запустить
- Скачайте код
- Откройте в браузере файл index.html

### Настройки
Внизу справа на странице можно включить отладочный режим логгирования и указать нестандартный адрес веб-сокета.
<img src="screenshots/settings.png">  
Настройки сохраняются в Local Storage браузера и не пропадают после обновления страницы. Чтобы сбросить настройки удалите ключи из Local Storage с помощью Chrome Dev Tools —> Вкладка Application —> Local Storage.
Если что-то работает не так, как ожидалось, то начните с включения отладочного режима логгирования.


## Скрипты приложения

### [server.py](server.py)
Скрипт приема данных об автобусах, формирования пула автобусов, расположенных в видимых на экране границах местности,
и передачи этого пула с заданной периодичностью браузеру для отображения.

#### Настройки
Хост по умолчанию `127.0.0.1`. Настроки берутся из аргументов командной строки при запуске скрипта или определяются по умолчанию в коде программы:  
- --browser_port или -brop [PORT] - порт для общения с браузером, по умолчанию `8000` 
- --bus_port или -busp [PORT] - порт для общения с генератором автобусов, по умолчанию `8080`
- --refresh_timeout или -t [TIMEOUT] - задержка в обновлении координат видимого пула автобусов, по умолчанию `1 сек`
- --verbose или -v [TRUE] - включение логирования


### [fake_bus.py](fake_bus.py)
Скрипт генерации данных о текущих координатах автобусов (с заданной задержкой) и передачи их последовательно на сервер.  
Должен быть запущен вместе с сервером.

#### Настройки
Настроки берутся из аргументов командной строки при запуске скрипта или определяются по умолчанию в коде программы:  
- --server или -s [SOKET] - адрес сервера, по умолчанию `ws://127.0.0.1:8080` 
- --routes_number или -r [NUMBER] - количество маршрутов, по умолчанию `1`
- --buses_per_route или -b [NUMBER] - количество автобусов на каждом маршруте, по умолчанию `1`
- --emulator_id или -e [PREFIX] - префикс к уникальному номеру автобуса на случай запуска нескольких экземпляров имитатора, по умолчанию `пусто`
- --websockets_number или -w [NUMBER] - количество открытых веб-сокетов для передачи кооринат автобусов, по умолчанию `3`
- --refresh_timeout или -t [TIMEOUT] - задержка в обновлении координат автобусов, по умолчанию `1 сек`
- --verbose или -v [TRUE] - включение логирования


### [harmful_bus.py](harmful_bus.py)
Скрипт генерации ошибочных (вредоносных) данных о текущих координатах автобусов для проверки модуля контроля на сервере.  
Должен быть запущен вместе с сервером.

В совокупности информирует о следующих ошибках:
- ошибка переданного формата JSON:
```shell
29-12-2023 13:58:09:INFO:harmful_bus_logger:{'errors': ['Requires valid JSON'], 'msgType': 'Errors'}
```

- в JSON нет информации об автобусе:
```shell
29-12-2023 13:58:09:INFO:harmful_bus_logger:{'errors': ['Requires busId specified'], 'msgType': 'Errors'}
```


### [harmful_client.py](harmful_client.py)
Скрипт генерации ошибочного (вредоносного) сообщения от браузера при передаче координат границ экрана.  
Должен быть запущен вместе с сервером.

В совокупности информирует о следующих ошибках:
- ошибка переданного формата JSON:
```shell
29-12-2023 14:03:22:INFO:harmful_client_logger:{'errors': ['Requires valid JSON (server)'], 'msgType': 'Errors'}
```

- в JSON нет информации о типе сообщения:
```shell
29-12-2023 14:03:22:INFO:harmful_client_logger:{'errors': ['Requires msgType specified'], 'msgType': 'Errors'}
```

- при этом в очереди отображается сообщение сервера браузеру с координатами пула видимых автобусов. При тестировании пул пуст.
Если запустить еще и [fake_bus.py](fake_bus.py) (скрипт генерации данных о текущих координатах автобусов), то в этом сообщении
будет присутствовать пул координат видимых автобусов.  
```shell
29-12-2023 14:03:22:INFO:harmful_client_logger:{'msgType': 'Buses', 'buses': []}
```


## Техническая информация для разработчиков
### Формат данных
Фронтенд ожидает получить от сервера JSON сообщение со списком автобусов:
```js
{
  "msgType": "Buses",
  "buses": [
    {"busId": "c790сс", "lat": 55.7500, "lng": 37.600, "route": "120"},
    {"busId": "a134aa", "lat": 55.7494, "lng": 37.621, "route": "670к"},
  ]
}
```

Те автобусы, что не попали в список `buses` последнего сообщения от сервера будут удалены с карты.

Фронтенд отслеживает перемещение пользователя по карте и отправляет на сервер новые координаты окна:
```js
{
  "msgType": "newBounds",
  "data": {
    "east_lng": 37.65563964843751,
    "north_lat": 55.77367652953477,
    "south_lat": 55.72628839374007,
    "west_lng": 37.54440307617188,
  },
}
```


## Используемые библиотеки в js
- [Leaflet](https://leafletjs.com/) — отрисовка карты
- [loglevel](https://www.npmjs.com/package/loglevel) для логгирования


## Цели проекта
Код написан в учебных целях — это урок в курсе по Python и веб-разработке на сайте [Devman](https://dvmn.org).
